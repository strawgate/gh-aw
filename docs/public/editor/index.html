<!DOCTYPE html>
<html lang="en" data-color-mode="auto" data-light-theme="light" data-dark-theme="dark">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>gh-aw Playground</title>
<link rel="icon" type="image/svg+xml" href="/gh-aw/favicon.svg" />
<link rel="stylesheet" href="https://unpkg.com/@primer/css@21/dist/primer.css">
<style>
/* ============================================================
   Minimal overrides — only what Primer CSS cannot handle
   ============================================================ */
html, body {
  height: 100%;
  overflow: hidden;
}

/* Editor textarea sizing & behavior */
.editor-textarea {
  flex: 1;
  width: 100%;
  height: 100%;
  padding: 12px 16px 12px 60px;
  font-size: 13px;
  line-height: 1.6;
  border: none;
  resize: none;
  outline: none;
  tab-size: 2;
  -moz-tab-size: 2;
  overflow: auto;
  background: var(--bgColor-default, var(--color-canvas-default));
  color: var(--fgColor-default, var(--color-fg-default));
}
.editor-textarea::placeholder {
  color: var(--fgColor-muted, var(--color-fg-muted));
}

/* Line numbers gutter */
.line-numbers {
  position: absolute;
  top: 0;
  left: 0;
  width: 48px;
  height: 100%;
  overflow: hidden;
  z-index: 2;
  background: var(--bgColor-muted, var(--color-canvas-subtle));
  border-right: 1px solid var(--borderColor-default, var(--color-border-default));
}
.line-numbers-inner {
  padding: 12px 0;
  font-size: 13px;
  line-height: 1.6;
  text-align: right;
  user-select: none;
  color: var(--fgColor-muted, var(--color-fg-muted));
}
.line-numbers-inner div {
  padding-right: 12px;
  height: 20.8px;
}

/* Draggable divider */
.divider {
  width: 5px;
  cursor: col-resize;
  flex-shrink: 0;
  z-index: 5;
  position: relative;
  background: var(--borderColor-default, var(--color-border-default));
  transition: background 180ms ease;
}
.divider::before {
  content: '';
  position: absolute;
  top: 0;
  left: -4px;
  right: -4px;
  bottom: 0;
}
.divider::after {
  content: '';
  width: 3px;
  height: 24px;
  border-radius: 2px;
  background: var(--fgColor-muted, var(--color-fg-muted));
  opacity: 0;
  transition: opacity 180ms ease;
  position: absolute;
  top: 50%;
  left: 1px;
  transform: translateY(-50%);
}
.divider:hover::after,
.divider.dragging::after {
  opacity: 0.5;
}
.divider:hover,
.divider.dragging {
  background: var(--fgColor-accent, var(--color-accent-fg));
}

/* Output pre sizing */
.output-pre {
  margin: 0;
  padding: 12px 16px;
  font-size: 13px;
  line-height: 1.6;
  white-space: pre;
  min-height: 100%;
}

/* Loading overlay & spinner */
.loading-overlay {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  background: var(--bgColor-default, var(--color-canvas-default));
  transition: opacity 300ms ease;
}
.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}
.loading-spinner {
  width: 40px;
  height: 40px;
  border: 3px solid var(--borderColor-default, var(--color-border-default));
  border-top-color: var(--fgColor-accent, var(--color-accent-fg));
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  margin-bottom: 16px;
}
@keyframes spin {
  to { transform: rotate(360deg); }
}

/* Status dot pulse */
.status-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: currentColor;
  flex-shrink: 0;
}
@keyframes pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.35; }
}

/* Toggle switch (no Primer equivalent in CSS-only) */
.toggle-track {
  position: relative;
  width: 34px;
  height: 20px;
  border-radius: 10px;
  background: var(--bgColor-neutral-muted, var(--color-neutral-muted, #afb8c1));
  transition: background 180ms ease;
  flex-shrink: 0;
  cursor: pointer;
}
.toggle-track.active {
  background: var(--fgColor-accent, var(--color-accent-fg));
}
.toggle-knob {
  position: absolute;
  top: 2px;
  left: 2px;
  width: 16px;
  height: 16px;
  background: #fff;
  border-radius: 50%;
  transition: transform 180ms ease;
  box-shadow: 0 1px 3px rgba(0,0,0,0.2);
}
.toggle-track.active .toggle-knob {
  transform: translateX(14px);
}

/* Responsive */
@media (max-width: 767px) {
  .panels-container { flex-direction: column !important; }
  .divider { width: 100%; height: 4px; cursor: row-resize; }
  .header-bar { gap: 8px !important; padding: 8px 12px !important; flex-wrap: wrap; height: auto !important; min-height: 48px !important; }
  .header-separator { display: none !important; }
  .auto-compile-label-text { display: none; }
}
</style>
</head>
<body class="color-bg-default color-fg-default">
<div class="d-flex flex-column" style="min-height: 100vh; width: 100vw;" id="app">
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="f4 color-fg-muted mb-1">Loading gh-aw compiler...</div>
    <div class="f6 color-fg-subtle">Downloading WebAssembly module (~17 MB)</div>
  </div>

  <!-- Header -->
  <header class="header-bar d-flex flex-items-center gap-2 px-3 color-bg-default border-bottom position-relative" style="height: 52px; min-height: 52px; z-index: 10;">
    <a class="d-flex flex-items-center gap-2 text-bold f5 color-fg-default no-underline flex-shrink-0" href="/gh-aw/" title="Back to docs">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="flex-shrink-0">
        <polyline points="4 17 10 11 4 5"></polyline>
        <line x1="12" y1="19" x2="20" y2="19"></line>
      </svg>
      <span>gh-aw Playground</span>
    </a>

    <div class="header-separator flex-shrink-0" style="width: 1px; height: 24px; background: var(--borderColor-default, var(--color-border-default));"></div>

    <span class="Label Label--accent d-inline-flex flex-items-center gap-1" id="statusBadge" data-status="loading">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Loading...</span>
    </span>

    <div class="d-flex flex-items-center gap-3 ml-auto">
      <label class="d-flex flex-items-center gap-1 f6 color-fg-muted cursor-pointer" style="white-space: nowrap; user-select: none;" id="autoCompileToggle" title="Auto-compile on change">
        <div class="toggle-track active" id="toggleTrack">
          <div class="toggle-knob"></div>
        </div>
        <span class="auto-compile-label-text">Auto</span>
      </label>

      <button class="btn btn-primary btn-sm" id="compileBtn" disabled title="Compile workflow">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor" class="flex-shrink-0">
          <path d="M4 2a1 1 0 011.5-.87l8.5 5a1 1 0 010 1.74l-8.5 5A1 1 0 014 12V2z"/>
        </svg>
        Compile
      </button>

      <button class="btn-octicon" id="themeToggle" title="Toggle theme" aria-label="Toggle dark mode">
        <!-- Sun icon (shown in dark mode) -->
        <svg class="icon-sun octicon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor" style="display:none">
          <path d="M8 12a4 4 0 100-8 4 4 0 000 8zm0-1.5a2.5 2.5 0 110-5 2.5 2.5 0 010 5zm5.657-8.157a.75.75 0 010 1.06l-1.061 1.06a.75.75 0 01-1.06-1.06l1.06-1.06a.75.75 0 011.06 0zm-9.193 9.193a.75.75 0 010 1.06l-1.06 1.061a.75.75 0 11-1.061-1.06l1.06-1.061a.75.75 0 011.061 0zM8 0a.75.75 0 01.75.75v1.5a.75.75 0 01-1.5 0V.75A.75.75 0 018 0zM3 8a.75.75 0 01-.75.75H.75a.75.75 0 010-1.5h1.5A.75.75 0 013 8zm13 0a.75.75 0 01-.75.75h-1.5a.75.75 0 010-1.5h1.5A.75.75 0 0116 8zm-8 8a.75.75 0 01-.75-.75v-1.5a.75.75 0 011.5 0v1.5A.75.75 0 018 16zm-5.657-2.343a.75.75 0 010-1.06l1.06-1.061a.75.75 0 111.06 1.06l-1.06 1.06a.75.75 0 01-1.06 0zm12.728 0l-1.06-1.06a.75.75 0 011.06-1.061l1.06 1.06a.75.75 0 01-1.06 1.06z"/>
        </svg>
        <!-- Moon icon (shown in light mode) -->
        <svg class="icon-moon octicon" width="16" height="16" viewBox="0 0 16 16" fill="currentColor">
          <path d="M9.598 1.591a.75.75 0 01.785-.175 7 7 0 11-8.967 8.967.75.75 0 01.961-.96 5.5 5.5 0 007.046-7.046.75.75 0 01.175-.786zm1.616 1.945a7 7 0 01-7.678 7.678 5.5 5.5 0 107.678-7.678z"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Error Banner -->
  <div class="flash flash-error d-none" id="errorBanner">
    <button class="flash-close" id="errorClose" type="button" aria-label="Dismiss">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.749.749 0 011.275.326.749.749 0 01-.215.734L9.06 8l3.22 3.22a.749.749 0 01-.326 1.275.749.749 0 01-.734-.215L8 9.06l-3.22 3.22a.751.751 0 01-1.042-.018.751.751 0 01-.018-1.042L6.94 8 3.72 4.78a.75.75 0 010-1.06z"/></svg>
    </button>
    <span class="text-mono f6" id="errorText"></span>
  </div>

  <!-- Warning Banner -->
  <div class="flash flash-warn d-none" id="warningBanner">
    <button class="flash-close" id="warningClose" type="button" aria-label="Dismiss">
      <svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M3.72 3.72a.75.75 0 011.06 0L8 6.94l3.22-3.22a.749.749 0 011.275.326.749.749 0 01-.215.734L9.06 8l3.22 3.22a.749.749 0 01-.326 1.275.749.749 0 01-.734-.215L8 9.06l-3.22 3.22a.751.751 0 01-1.042-.018.751.751 0 01-.018-1.042L6.94 8 3.72 4.78a.75.75 0 010-1.06z"/></svg>
    </button>
    <span class="text-mono f6" id="warningText"></span>
  </div>

  <!-- Main Panels -->
  <div class="panels-container d-flex flex-1" style="min-height: 0;" id="panels">
    <!-- Editor Panel -->
    <div class="d-flex flex-column" style="flex: 1 1 50%; min-width: 0; min-height: 0;" id="panelEditor">
      <div class="d-flex flex-items-center flex-justify-between px-3 py-2 color-bg-subtle border-bottom f6 text-bold text-uppercase color-fg-muted" style="letter-spacing: 0.5px; min-height: 36px; user-select: none;">
        <span class="d-flex flex-items-center gap-1">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
            <path d="M1.75 1h12.5c.966 0 1.75.784 1.75 1.75v10.5A1.75 1.75 0 0114.25 15H1.75A1.75 1.75 0 010 13.25V2.75C0 1.784.784 1 1.75 1zm12.5 1.5H1.75a.25.25 0 00-.25.25v10.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V2.75a.25.25 0 00-.25-.25zM3 5.5a.75.75 0 01.75-.75h8.5a.75.75 0 010 1.5h-8.5A.75.75 0 013 5.5zm0 4a.75.75 0 01.75-.75h5.5a.75.75 0 010 1.5h-5.5A.75.75 0 013 9.5z"/>
          </svg>
          Workflow (.md)
        </span>
        <kbd class="color-bg-subtle color-fg-muted text-mono" style="padding: 1px 5px; font-size: 11px; border: 1px solid var(--borderColor-default, var(--color-border-default)); border-radius: 3px; line-height: 1.4;" title="Press to compile">
          <span class="kbd-hint-mac" style="display:none">&#8984;&#9166;</span>
          <span class="kbd-hint-other">Ctrl+Enter</span>
        </kbd>
      </div>
      <div class="flex-1 d-flex position-relative" style="min-height: 0; overflow: hidden;">
        <div class="line-numbers" id="lineNumbers">
          <div class="line-numbers-inner text-mono" id="lineNumbersInner"></div>
        </div>
        <textarea
          class="editor-textarea text-mono"
          id="editor"
          spellcheck="false"
          autocapitalize="off"
          autocomplete="off"
          autocorrect="off"
          placeholder="Write your agentic workflow here..."
        ></textarea>
      </div>
    </div>

    <div class="divider" id="divider"></div>

    <!-- Output Panel -->
    <div class="d-flex flex-column" style="flex: 1 1 50%; min-width: 0; min-height: 0;" id="panelOutput">
      <div class="d-flex flex-items-center flex-justify-between px-3 py-2 color-bg-subtle border-bottom f6 text-bold text-uppercase color-fg-muted" style="letter-spacing: 0.5px; min-height: 36px; user-select: none;">
        <span class="d-flex flex-items-center gap-1">
          <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="opacity: 0.6;">
            <path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v12.5A1.75 1.75 0 0114.25 16H1.75A1.75 1.75 0 010 14.25Zm1.75-.25a.25.25 0 00-.25.25v12.5c0 .138.112.25.25.25h12.5a.25.25 0 00.25-.25V1.75a.25.25 0 00-.25-.25Zm7.47 3.97a.75.75 0 011.06 0l2 2a.75.75 0 010 1.06l-2 2a.75.75 0 11-1.06-1.06L10.69 8 9.22 6.53a.75.75 0 010-1.06zm-3.44 0a.75.75 0 010 1.06L4.31 8l1.47 1.47a.75.75 0 01-1.06 1.06l-2-2a.75.75 0 010-1.06l2-2a.75.75 0 011.06 0z"/>
          </svg>
          Compiled Output (.lock.yml)
        </span>
      </div>
      <div class="flex-1 overflow-auto color-bg-subtle" style="min-height: 0;" id="outputContainer">
        <div class="d-flex flex-items-center flex-justify-center color-fg-muted f5 p-4 text-center" style="height: 100%;" id="outputPlaceholder">
          Compiled YAML will appear here
        </div>
        <pre class="output-pre text-mono color-fg-default" id="outputPre" style="display:none"></pre>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="d-flex flex-column flex-items-center gap-2 px-3 py-3 color-bg-default border-top f6" style="min-height: 60px;">
    <div class="d-flex flex-items-center gap-2 color-fg-muted flex-wrap flex-justify-center">
      <span>Made with</span>
      <svg width="14" height="14" viewBox="0 0 16 16" fill="currentColor" style="color: #8b5cf6;">
        <path d="M7.655 14.916v-.001h-.002l-.006-.003-.018-.01a22.066 22.066 0 0 1-3.744-2.584C2.045 10.731 0 8.35 0 5.5 0 2.836 2.086 1 4.25 1 5.797 1 7.153 1.802 8 3.02 8.847 1.802 10.203 1 11.75 1 13.914 1 16 2.836 16 5.5c0 2.85-2.044 5.231-3.886 6.818a22.094 22.094 0 0 1-3.433 2.414 7.152 7.152 0 0 1-.31.17l-.018.01-.008.004a.75.75 0 0 1-.69 0Z"/>
      </svg>
      <span>by</span>
      <a href="https://githubnext.com/" target="_blank" rel="noopener noreferrer" class="Link--primary">GitHub Next</a>
      <span>&amp;</span>
      <a href="https://www.microsoft.com/en-us/research/" target="_blank" rel="noopener noreferrer" class="Link--primary">Microsoft Research</a>
    </div>
    <div class="d-flex flex-items-center gap-2 color-fg-subtle flex-wrap flex-justify-center">
      <a href="https://docs.github.com/en/site-policy/github-terms/github-terms-of-service" target="_blank" rel="noopener noreferrer" class="Link--secondary">Terms</a>
      <span aria-hidden="true">·</span>
      <a href="https://docs.github.com/en/site-policy/privacy-policies/github-general-privacy-statement" target="_blank" rel="noopener noreferrer" class="Link--secondary">Privacy</a>
      <span aria-hidden="true">·</span>
      <a href="https://github.com/security" target="_blank" rel="noopener noreferrer" class="Link--secondary">Security</a>
    </div>
  </footer>
</div>

<script type="module">
// ================================================================
// gh-aw Playground - Application Logic
// ================================================================

import { createWorkerCompiler } from '/gh-aw/wasm/compiler-loader.js';

// ---------------------------------------------------------------
// Default workflow content
// ---------------------------------------------------------------
const DEFAULT_CONTENT = [
  '---',
  'name: hello-world',
  'description: A simple hello world workflow',
  'on:',
  '  workflow_dispatch:',
  'engine: copilot',
  '---',
  '',
  '# Mission',
  '',
  'Say hello to the world! Check the current date and time, and greet the user warmly.',
  ''
].join('\n');

// ---------------------------------------------------------------
// DOM Elements
// ---------------------------------------------------------------
const $ = (id) => document.getElementById(id);

const editor = $('editor');
const outputPre = $('outputPre');
const outputPlaceholder = $('outputPlaceholder');
const outputContainer = $('outputContainer');
const compileBtn = $('compileBtn');
const statusBadge = $('statusBadge');
const statusText = $('statusText');
const statusDot = $('statusDot');
const loadingOverlay = $('loadingOverlay');
const errorBanner = $('errorBanner');
const errorText = $('errorText');
const warningBanner = $('warningBanner');
const warningText = $('warningText');
const lineNumbersInner = $('lineNumbersInner');
const themeToggle = $('themeToggle');
const toggleTrack = $('toggleTrack');
const divider = $('divider');
const panelEditor = $('panelEditor');
const panelOutput = $('panelOutput');
const panels = $('panels');

// ---------------------------------------------------------------
// State
// ---------------------------------------------------------------
let compiler = null;
let isReady = false;
let isCompiling = false;
let autoCompile = true;
let compileTimer = null;
let currentYaml = '';

// ---------------------------------------------------------------
// Theme (uses Primer's data-color-mode)
// ---------------------------------------------------------------
function getPreferredTheme() {
  const saved = localStorage.getItem('gh-aw-playground-theme');
  if (saved) return saved;
  return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
}

function setTheme(theme) {
  document.documentElement.setAttribute('data-color-mode', theme);
  localStorage.setItem('gh-aw-playground-theme', theme);
  const sunIcon = themeToggle.querySelector('.icon-sun');
  const moonIcon = themeToggle.querySelector('.icon-moon');
  if (theme === 'dark') {
    sunIcon.style.display = 'block';
    moonIcon.style.display = 'none';
  } else {
    sunIcon.style.display = 'none';
    moonIcon.style.display = 'block';
  }
}

setTheme(getPreferredTheme());

themeToggle.addEventListener('click', () => {
  const current = document.documentElement.getAttribute('data-color-mode');
  setTheme(current === 'dark' ? 'light' : 'dark');
});

// Listen for OS theme changes
window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
  if (!localStorage.getItem('gh-aw-playground-theme')) {
    setTheme(e.matches ? 'dark' : 'light');
  }
});

// ---------------------------------------------------------------
// Keyboard shortcut hint (Mac vs other)
// ---------------------------------------------------------------
const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
document.querySelectorAll('.kbd-hint-mac').forEach(el => el.style.display = isMac ? 'inline' : 'none');
document.querySelectorAll('.kbd-hint-other').forEach(el => el.style.display = isMac ? 'none' : 'inline');

// ---------------------------------------------------------------
// Status (uses Primer Label component)
// ---------------------------------------------------------------
const STATUS_LABEL_MAP = {
  loading: 'Label--accent',
  ready: 'Label--success',
  compiling: 'Label--accent',
  error: 'Label--danger'
};

function setStatus(status, text) {
  // Swap Label modifier class
  Object.values(STATUS_LABEL_MAP).forEach(cls => statusBadge.classList.remove(cls));
  statusBadge.classList.add(STATUS_LABEL_MAP[status] || 'Label--secondary');
  statusBadge.setAttribute('data-status', status);
  statusText.textContent = text;

  // Pulse animation for loading/compiling states
  if (status === 'loading' || status === 'compiling') {
    statusDot.style.animation = 'pulse 1.2s ease-in-out infinite';
  } else {
    statusDot.style.animation = '';
  }
}

// ---------------------------------------------------------------
// Line numbers
// ---------------------------------------------------------------
function updateLineNumbers() {
  const lines = editor.value.split('\n').length;
  let html = '';
  for (let i = 1; i <= lines; i++) {
    html += '<div>' + i + '</div>';
  }
  lineNumbersInner.innerHTML = html;
}

function syncLineNumberScroll() {
  const lineNumbers = $('lineNumbers');
  lineNumbers.scrollTop = editor.scrollTop;
}

// ---------------------------------------------------------------
// Editor setup
// ---------------------------------------------------------------
editor.value = DEFAULT_CONTENT;
updateLineNumbers();

editor.addEventListener('input', () => {
  updateLineNumbers();
  if (autoCompile && isReady) {
    scheduleCompile();
  }
});

editor.addEventListener('scroll', syncLineNumberScroll);

// Tab key inserts 2 spaces
editor.addEventListener('keydown', (e) => {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = editor.selectionStart;
    const end = editor.selectionEnd;
    const val = editor.value;
    editor.value = val.substring(0, start) + '  ' + val.substring(end);
    editor.selectionStart = editor.selectionEnd = start + 2;
    editor.dispatchEvent(new Event('input'));
  }

  // Ctrl+Enter or Cmd+Enter to compile
  if (e.key === 'Enter' && (e.ctrlKey || e.metaKey)) {
    e.preventDefault();
    doCompile();
  }
});

// ---------------------------------------------------------------
// Auto-compile toggle
// ---------------------------------------------------------------
$('autoCompileToggle').addEventListener('click', () => {
  autoCompile = !autoCompile;
  if (autoCompile) {
    toggleTrack.classList.add('active');
  } else {
    toggleTrack.classList.remove('active');
  }
});

// ---------------------------------------------------------------
// Compile
// ---------------------------------------------------------------
function scheduleCompile() {
  if (compileTimer) clearTimeout(compileTimer);
  compileTimer = setTimeout(doCompile, 400);
}

async function doCompile() {
  if (!isReady || isCompiling) return;
  if (compileTimer) {
    clearTimeout(compileTimer);
    compileTimer = null;
  }

  const md = editor.value;
  if (!md.trim()) {
    outputPre.style.display = 'none';
    outputPlaceholder.style.display = 'flex';
    outputPlaceholder.textContent = 'Compiled YAML will appear here';
    currentYaml = '';
    return;
  }

  isCompiling = true;
  setStatus('compiling', 'Compiling...');
  compileBtn.disabled = true;

  // Hide old banners
  errorBanner.classList.add('d-none');
  warningBanner.classList.add('d-none');

  try {
    const result = await compiler.compile(md);

    if (result.error) {
      setStatus('error', 'Error');
      errorText.textContent = result.error;
      errorBanner.classList.remove('d-none');
    } else {
      setStatus('ready', 'Ready');
      currentYaml = result.yaml;
      outputPre.textContent = result.yaml;
      outputPre.style.display = 'block';
      outputPlaceholder.style.display = 'none';

      if (result.warnings && result.warnings.length > 0) {
        warningText.textContent = result.warnings.join('\n');
        warningBanner.classList.remove('d-none');
      }
    }
  } catch (err) {
    setStatus('error', 'Error');
    errorText.textContent = err.message || String(err);
    errorBanner.classList.remove('d-none');
  } finally {
    isCompiling = false;
    compileBtn.disabled = !isReady;
  }
}

compileBtn.addEventListener('click', doCompile);

// ---------------------------------------------------------------
// Banner close
// ---------------------------------------------------------------
$('errorClose').addEventListener('click', () => errorBanner.classList.add('d-none'));
$('warningClose').addEventListener('click', () => warningBanner.classList.add('d-none'));

// ---------------------------------------------------------------
// Draggable divider
// ---------------------------------------------------------------
let isDragging = false;

divider.addEventListener('mousedown', (e) => {
  isDragging = true;
  divider.classList.add('dragging');
  document.body.style.cursor = 'col-resize';
  document.body.style.userSelect = 'none';
  e.preventDefault();
});

document.addEventListener('mousemove', (e) => {
  if (!isDragging) return;
  const rect = panels.getBoundingClientRect();
  const isMobile = window.innerWidth < 768;

  if (isMobile) {
    const fraction = (e.clientY - rect.top) / rect.height;
    const clamped = Math.max(0.2, Math.min(0.8, fraction));
    panelEditor.style.flex = `0 0 ${clamped * 100}%`;
    panelOutput.style.flex = `0 0 ${(1 - clamped) * 100}%`;
  } else {
    const fraction = (e.clientX - rect.left) / rect.width;
    const clamped = Math.max(0.2, Math.min(0.8, fraction));
    panelEditor.style.flex = `0 0 ${clamped * 100}%`;
    panelOutput.style.flex = `0 0 ${(1 - clamped) * 100}%`;
  }
});

document.addEventListener('mouseup', () => {
  if (isDragging) {
    isDragging = false;
    divider.classList.remove('dragging');
    document.body.style.cursor = '';
    document.body.style.userSelect = '';
  }
});

// Touch support for mobile divider
divider.addEventListener('touchstart', (e) => {
  isDragging = true;
  divider.classList.add('dragging');
  e.preventDefault();
});

document.addEventListener('touchmove', (e) => {
  if (!isDragging) return;
  const touch = e.touches[0];
  const rect = panels.getBoundingClientRect();
  const isMobile = window.innerWidth < 768;

  if (isMobile) {
    const fraction = (touch.clientY - rect.top) / rect.height;
    const clamped = Math.max(0.2, Math.min(0.8, fraction));
    panelEditor.style.flex = `0 0 ${clamped * 100}%`;
    panelOutput.style.flex = `0 0 ${(1 - clamped) * 100}%`;
  } else {
    const fraction = (touch.clientX - rect.left) / rect.width;
    const clamped = Math.max(0.2, Math.min(0.8, fraction));
    panelEditor.style.flex = `0 0 ${clamped * 100}%`;
    panelOutput.style.flex = `0 0 ${(1 - clamped) * 100}%`;
  }
});

document.addEventListener('touchend', () => {
  if (isDragging) {
    isDragging = false;
    divider.classList.remove('dragging');
  }
});

// ---------------------------------------------------------------
// Initialize compiler
// ---------------------------------------------------------------
async function init() {
  try {
    compiler = createWorkerCompiler({
      workerUrl: '/gh-aw/wasm/compiler-worker.js'
    });

    await compiler.ready;
    isReady = true;
    setStatus('ready', 'Ready');
    compileBtn.disabled = false;
    loadingOverlay.classList.add('hidden');

    // Auto-compile the default content
    if (autoCompile) {
      doCompile();
    }
  } catch (err) {
    setStatus('error', 'Failed to load');
    loadingOverlay.querySelector('.f4').textContent = 'Failed to load compiler';
    loadingOverlay.querySelector('.f6').textContent = err.message;
    loadingOverlay.querySelector('.loading-spinner').style.display = 'none';
  }
}

init();
</script>
</body>
</html>
