name: Copilot SDK CI

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'copilot-client/**'
      - '.github/workflows/copilot-sdk-ci.yml'

permissions:
  contents: read

concurrency:
  group: copilot-sdk-ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5

      - name: Setup Node.js
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f # v6
        with:
          node-version: '24'
          cache: 'npm'
          cache-dependency-path: copilot-client/package-lock.json

      - name: Install Copilot CLI
        run: |
          # Read version from constants.go (skip commented lines)
          COPILOT_VERSION=$(grep 'DefaultCopilotVersion Version = "' pkg/constants/constants.go | grep -v '^//' | grep -oP '"\K[^"]+')
          echo "Installing Copilot CLI version: $COPILOT_VERSION"
          npm install -g @github/copilot@$COPILOT_VERSION

      - name: Start Copilot CLI as headless server
        id: copilot_server
        run: |
          mkdir -p /tmp/copilot-logs
          mkdir -p /tmp/copilot-server
          
          # Start copilot in server mode
          copilot --server --port 8080 --log-level all --log-dir /tmp/copilot-logs > /tmp/copilot-server/output.log 2>&1 &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV
          
          # Wait for server to be ready
          sleep 5
          
          # Check if server is running
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "Failed to start copilot server"
            cat /tmp/copilot-server/output.log
            exit 1
          fi
          
          echo "Copilot server started with PID: $SERVER_PID"
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Install copilot-client dependencies
        run: |
          cd copilot-client
          npm ci

      - name: Build copilot-client
        run: |
          cd copilot-client
          npm run build

      - name: Run copilot-client tests
        run: |
          cd copilot-client
          npm test
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Test copilot-client integration
        run: |
          cd copilot-client
          
          # Create test prompt
          mkdir -p /tmp/test
          echo "What is 2+2? Answer briefly." > /tmp/test/prompt.txt
          
          # Create configuration JSON for environment variable
          export GH_AW_COPILOT_CONFIG='{
            "promptFile": "/tmp/test/prompt.txt",
            "eventLogFile": "/tmp/test/events.jsonl",
            "cliUrl": "localhost:8080",
            "session": {
              "model": "gpt-5"
            }
          }'
          
          # Run the client with configuration from environment variable
          DEBUG=copilot-client node -e "import('./dist/index.js').then(m => m.main())"
          
          # Verify event log was created
          if [ ! -f /tmp/test/events.jsonl ]; then
            echo "Event log file was not created"
            exit 1
          fi
          
          # Check that events were logged
          EVENT_COUNT=$(wc -l < /tmp/test/events.jsonl)
          echo "Number of events logged: $EVENT_COUNT"
          
          if [ "$EVENT_COUNT" -lt 3 ]; then
            echo "Expected at least 3 events, got $EVENT_COUNT"
            cat /tmp/test/events.jsonl
            exit 1
          fi
          
          echo "âœ“ Integration test passed"
        env:
          COPILOT_GITHUB_TOKEN: ${{ secrets.COPILOT_GITHUB_TOKEN }}

      - name: Stop Copilot server
        if: always()
        run: |
          if [ -n "$SERVER_PID" ]; then
            echo "Stopping copilot server (PID: $SERVER_PID)"
            kill $SERVER_PID || true
            sleep 2
          fi

      - name: Upload copilot logs
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: copilot-logs
          path: /tmp/copilot-logs/
          if-no-files-found: ignore

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-artifacts
          path: /tmp/test/
          if-no-files-found: ignore
